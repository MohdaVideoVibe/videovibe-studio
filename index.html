<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Editor & Splitter</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        input, button { margin: 10px; padding: 5px; }
        #status { color: green; }
        #error { color: red; }
        #progress { margin-top: 10px; }
        #downloadAllBtn { display: none; }
    </style>
</head>
<body>
    <h1>Video Editor & Splitter</h1>
    <input type="file" id="videoInput" accept="video/*">
    <br>
    <label for="splitTime">Split at (seconds):</label>
    <input type="number" id="splitTime" min="1" placeholder="Enter time (e.g., 45)">
    <br>
    <button onclick="processVideo()">Process Video</button>
    <br>
    <div id="status"></div>
    <div id="progress"></div>
    <div id="error"></div>
    <button id="downloadAllBtn" onclick="downloadAll()">Download All Segments</button>

    <!-- Load FFmpeg.js from CDN -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        let downloadURLs = []; // Store URLs for all segments

        async function processVideo() {
            const videoInput = document.getElementById('videoInput').files[0];
            const splitTime = parseInt(document.getElementById('splitTime').value);
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const error = document.getElementById('error');
            const downloadAllBtn = document.getElementById('downloadAllBtn');

            // Reset UI
            status.textContent = '';
            progress.textContent = '';
            error.textContent = '';
            downloadAllBtn.style.display = 'none';
            downloadURLs = [];

            if (!videoInput) {
                error.textContent = 'Please upload a video.';
                return;
            }
            if (!splitTime || splitTime <= 0) {
                error.textContent = 'Please enter a valid split time greater than 0.';
                return;
            }

            status.textContent = 'Loading FFmpeg...';
            if (!ffmpeg.isLoaded()) await ffmpeg.load();

            status.textContent = 'Enhancing video...';
            try {
                // Write the uploaded video to FFmpeg's virtual filesystem
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoInput));

                // Enhance video with filters
                await ffmpeg.run(
                    '-i', 'input.mp4',
                    '-vf', 'unsharp=5:5:1.0,eq=contrast=1.2:brightness=0.08:saturation=1.3,hqdn3d,fps=60',
                    '-c:v', 'libx264',
                    '-preset', 'slow',
                    '-crf', '18',
                    '-c:a', 'aac',
                    '-b:a', '192k',
                    'enhanced.mp4'
                );

                // Get enhanced video duration
                const probe = await ffmpeg.run('-i', 'enhanced.mp4');
                const logs = ffmpeg.FS('readFile', 'stderr').toString();
                const durationMatch = logs.match(/Duration: (\d{2}):(\d{2}):(\d{2}\.\d{2})/);
                if (!durationMatch) throw new Error('Could not determine video duration.');
                const duration = parseInt(durationMatch[1]) * 3600 + parseInt(durationMatch[2]) * 60 + parseFloat(durationMatch[3]);

                // Calculate segments
                const segmentCount = Math.ceil(duration / splitTime);
                status.textContent = 'Splitting enhanced video...';

                for (let i = 0; i < segmentCount; i++) {
                    const start = i * splitTime;
                    const outputFile = `output_part${i + 1}.mp4`;

                    // Split enhanced video
                    await ffmpeg.run(
                        '-i', 'enhanced.mp4',
                        '-ss', start.toString(),
                        '-t', splitTime.toString(),
                        '-c:v', 'copy',
                        '-c:a', 'copy',
                        outputFile
                    );

                    // Update progress
                    progress.textContent = `Processed segment ${i + 1} of ${segmentCount}`;

                    // Read the output file and store URL
                    const data = ffmpeg.FS('readFile', outputFile);
                    const blob = new Blob([data.buffer], { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    downloadURLs.push({ url, filename: `GameplayMaster_part${i + 1}.mp4` });
                }

                status.textContent = 'Processing complete! Click below to download all segments.';
                progress.textContent = '';
                downloadAllBtn.style.display = 'block';
            } catch (e) {
                error.textContent = `Error: ${e.message}`;
                status.textContent = '';
            }
        }

        function downloadAll() {
            downloadURLs.forEach(({ url, filename }) => {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    </script>
</body>
</html>